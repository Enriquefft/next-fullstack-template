#!/usr/bin/env bash
set -euo pipefail

# gcommit - Git commit with Claude Haiku-generated messages
# Usage: gcommit [--dry-run] [--amend]

readonly SCRIPT_NAME="gcommit"
readonly MODEL="claude-haiku-4-20250414"
readonly MAX_DIFF_SIZE=50000

# Colors for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m' # No Color

log_info() { echo -e "${BLUE}[INFO]${NC} $*"; }
log_success() { echo -e "${GREEN}[OK]${NC} $*"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*" >&2; }

die() {
	log_error "$@"
	exit 1
}

# Check dependencies
check_dependencies() {
	local missing=()

	if ! command -v git &>/dev/null; then
		missing+=("git")
	fi

	if ! command -v curl &>/dev/null; then
		missing+=("curl")
	fi

	if ! command -v jq &>/dev/null; then
		missing+=("jq")
	fi

	if [[ ${#missing[@]} -gt 0 ]]; then
		die "Missing required dependencies: ${missing[*]}"
	fi
}

# Check if in a git repository
check_git_repo() {
	if ! git rev-parse --is-inside-work-tree &>/dev/null; then
		die "Not inside a git repository"
	fi
}

# Check for API key
check_api_key() {
	if [[ -z "${ANTHROPIC_API_KEY:-}" ]]; then
		die "ANTHROPIC_API_KEY environment variable is not set"
	fi
}

# Get staged diff
get_staged_diff() {
	local diff
	diff=$(git diff --cached --no-color 2>/dev/null)

	if [[ -z "$diff" ]]; then
		die "No staged changes to commit. Use 'git add' first."
	fi

	# Truncate if too large
	if [[ ${#diff} -gt $MAX_DIFF_SIZE ]]; then
		log_warn "Diff is large (${#diff} chars), truncating to $MAX_DIFF_SIZE chars"
		diff="${diff:0:$MAX_DIFF_SIZE}

... [truncated - diff too large]"
	fi

	echo "$diff"
}

# Get recent commit messages for style reference
get_recent_commits() {
	git log --oneline -10 2>/dev/null || echo ""
}

# Get list of staged files
get_staged_files() {
	git diff --cached --name-only 2>/dev/null
}

# Generate commit message using Claude Haiku
generate_commit_message() {
	local diff="$1"
	local recent_commits="$2"
	local staged_files="$3"

	local prompt
	prompt=$(
		cat <<'EOF'
Generate a concise git commit message for these changes. Follow conventional commit format:
- Use type: feat, fix, chore, docs, style, refactor, test, perf
- First line: type: short description (max 72 chars, lowercase, no period)
- If needed, add blank line then brief body explaining WHY (not what)
- End with the standard footer

Example format:
feat: add user authentication flow

Implements OAuth2 login with session management for improved security.

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>

IMPORTANT: Output ONLY the commit message, nothing else. No markdown, no explanation.
EOF
	)

	local user_content
	user_content=$(
		cat <<EOF
Recent commits for style reference:
$recent_commits

Staged files:
$staged_files

Diff:
$diff
EOF
	)

	# Escape for JSON
	local escaped_prompt escaped_content
	escaped_prompt=$(echo "$prompt" | jq -Rs .)
	escaped_content=$(echo "$user_content" | jq -Rs .)

	local request_body
	request_body=$(
		cat <<EOF
{
  "model": "$MODEL",
  "max_tokens": 500,
  "messages": [
    {
      "role": "user",
      "content": [
        {"type": "text", "text": $escaped_prompt},
        {"type": "text", "text": $escaped_content}
      ]
    }
  ]
}
EOF
	)

	local response http_code body
	response=$(
		curl -s -w "\n%{http_code}" \
			-X POST "https://api.anthropic.com/v1/messages" \
			-H "Content-Type: application/json" \
			-H "x-api-key: $ANTHROPIC_API_KEY" \
			-H "anthropic-version: 2023-06-01" \
			-d "$request_body" \
			--max-time 30
	) || die "Failed to connect to Anthropic API"

	http_code=$(echo "$response" | tail -n1)
	body=$(echo "$response" | sed '$d')

	if [[ "$http_code" != "200" ]]; then
		local error_msg
		error_msg=$(echo "$body" | jq -r '.error.message // "Unknown error"' 2>/dev/null || echo "Unknown error")
		die "API request failed (HTTP $http_code): $error_msg"
	fi

	local commit_msg
	commit_msg=$(echo "$body" | jq -r '.content[0].text // empty' 2>/dev/null)

	if [[ -z "$commit_msg" ]]; then
		die "Failed to extract commit message from API response"
	fi

	echo "$commit_msg"
}

# Main function
main() {
	local dry_run=false
	local amend=false

	# Parse arguments
	while [[ $# -gt 0 ]]; do
		case "$1" in
		--dry-run | -n)
			dry_run=true
			shift
			;;
		--amend)
			amend=true
			shift
			;;
		--help | -h)
			echo "Usage: $SCRIPT_NAME [--dry-run] [--amend]"
			echo ""
			echo "Options:"
			echo "  --dry-run, -n  Show generated message without committing"
			echo "  --amend        Amend the previous commit"
			echo "  --help, -h     Show this help message"
			exit 0
			;;
		*)
			die "Unknown option: $1"
			;;
		esac
	done

	# Run checks
	check_dependencies
	check_git_repo
	check_api_key

	log_info "Analyzing staged changes..."

	local diff staged_files recent_commits
	diff=$(get_staged_diff)
	staged_files=$(get_staged_files)
	recent_commits=$(get_recent_commits)

	log_info "Generating commit message with Claude Haiku..."

	local commit_msg
	commit_msg=$(generate_commit_message "$diff" "$recent_commits" "$staged_files")

	echo ""
	echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	echo "$commit_msg"
	echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	echo ""

	if $dry_run; then
		log_info "Dry run mode - not committing"
		exit 0
	fi

	# Commit
	local commit_args=(-m "$commit_msg")
	if $amend; then
		commit_args+=(--amend)
	fi

	if git commit "${commit_args[@]}"; then
		log_success "Commit created successfully!"
	else
		die "Failed to create commit"
	fi
}

main "$@"
